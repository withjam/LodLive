$(function(){function e(e){var t=$('<div class="myalert '+r+'"><div>'+e+"</div></div>");t.click(function(){$(this).remove()}),$(".myalert").length>0&&$(".myalert").remove(),$("body").append(t),t.css({top:$(window).height()/2+$("body").scrollTop()})}function t(e,t){e.children("h1").children("span").click(function(){t.css({position:"absolute",top:e.position().top,left:e.position().left}),t.fadeIn("fast"),$("div.selectionList",form).length>0&&form.find("div.select").click()}),t.click(function(){t.fadeOut("fast")})}function n(t){var n=$('<div class="inviaForm"></div>');n.click(function(){t.submit()}),t.append(n),n.hover(function(){$(this).parent().parent().setBackgroundPosition({x:-320})},function(){$(this).parent().parent().setBackgroundPosition({x:-10})}),t.bind("submit",function(){var t=$(this).find("*[name=startFrom]").val();return""!=t?document.location="?"+$.trim(t):e(lang("impostaUnaURI")),!1})}function i(e,i){var o=$('<div class="startBox '+r+'" id="boxB"><h1><span>'+lang("insertUri")+'</span><span class="'+r+' info"></span></h1></div>');e.append(o);var a=$('<div class="startBox infoHome hdPage" ><h1><span>'+lang("insertUri")+"</span></h1><p>"+lang("insertUriDescription")+"</p></div>");e.append(a),t(o,a);var s=$(i),l=s.find("div.input"),d=$('<div class="input textarea"><textarea name="startFrom"></textarea></div>');l.before(d),l.remove(),s.children(".select").remove(),s.find("input").attr("readonly",!1),e.children("#boxB").append(s),n(s),s.find(".inviaForm").attr("style","top: 138px")}function o(e){var t=$('<div class="startBox '+r+' endpList"></div>');e.prepend(t);var n=$('<form><div class="select"><span>'+lang("choose")+'</span><span class="'+r+' arrow"></span></div></form>');t.append(n),t.find("div.select").click(function(){if($(this).data("show"))$(this).data("show",!1),$(".slimScrollDiv",n).remove();else{$(this).data("show",!0);var e=$(this),i=$('<div class="selectionList"></div>');$.each($.jStorage.get("profile").connection,function(e){i.append('<div class="selectEle" rel="'+e+'"><span>'+e.replace(/,.*/g,"").replace(/http:\/\//gi,"")+"</span></div>")}),n.append(i),i.css({left:e.position().left}),n.find(".selectEle").click(function(){e.click();for(var t=$(this).attr("rel"),n=$("div[rel='"+t+"'].startBox:first").position().left+310,i=(n/930+"").indexOf(".")>0?parseInt(n/930+"".replace(/\.[0-9]*/,""))+1:n/930,o=0;i-1>o;o++)$.doTimeout(205*o,function(){l=0,d=0,$("#nextPage").click()})}),$(".slimScrollDiv",n).remove(),i.css({display:"block"}),i.slimScroll({height:100,width:200,color:"#000"}),$(".slimScrollDiv",n).css({position:"absolute",display:"block",zIndex:"9999",left:e.position().left,top:e.position().top+280}),$(".slimScrollDiv",n).hover(function(){},function(){t.find("div.select").click()})}})}function a(e,i){var o=$('<div class="startBox '+r+'" id="boxO"><h1><span>'+lang("simpleSearch")+'</span><span class="'+r+' info"></span></h1></div>');e.append(o);var a=$('<div class="startBox infoHome hdPage" ><h1><span>'+lang("simpleSearch")+"</span></h1><p>"+lang("simpleSearchDescription")+"</p></div>");e.append(a),t(o,a);var l=$(i);e.children("#boxO").append(l),l.children(".input").before($('<div class="inputClass"><input type="text" name="classFrom" value="" readonly="readonly"></div>')),l.find("div.select").click(function(){if($(this).data("show"))$(this).data("show",!1),$("div.selectionList",l).remove();else{$(this).data("show",!0);var e=$(this),t=$('<div class="selectionList"></div>');t.append('<div class="selectEle" rel="dbpedia"><span>dbpedia.org</span></div>'),t.append('<div class="selectEle" rel="freebase"><span>freebase.com</span></div>'),t.hover(function(){},function(){e.click()}),l.append(t),t.css({position:"absolute",zIndex:"9999",left:e.position().left,top:e.position().top+60}),l.find(".selectEle").click(function(){e.click();var t=$(this).attr("rel"),n=l.find("input[name=classFrom]");n.unbind("focus"),n.unbind("keyup"),n.val("").removeAttr("readonly").css({background:"#fff",color:"#975E1C"}).focus().parent().css({background:"#fff"});var i=$('<div class="inviaForm2" style="display:none"></div>'),o=l.find(".inputClass"),a=null;n.keyup(function(){$(this).val().length>0&&(clearTimeout(a),a=setTimeout(function(){i.click()},250))}),n.focus(function(){l.find(".selectionList").remove(),i.click()}),i.click(function(){if(l.find(".selectionList").remove(),n.val().length>0){l.children("div.input").children("img").remove(),l.children("div.input").prepend('<img src="img/ajax-loader-white.gif" style="margin-left:6px;margin-top:2px"/>');var e=[];e=s(t,n.val(),function(){l.children("div.input").children("img").remove();for(var t=$('<div class="selectionList"></div>'),i=0;i<e.length;i++){var o=e[i];t.append('<div class="selectEle" ><span title="'+decodeURIComponent(o.uri)+'">'+o.label+"</span></div>")}l.append(t),t.find("span").click(function(){n.val($(this).text()),l.find("input[name=startFrom]").val($(this).attr("title")),$(".selectionList").remove()}),t.hover(function(){},function(){l.find(".selectionList").remove()}),t.css({position:"absolute",zIndex:"9999",display:"block",left:n.position().left,top:n.position().top+20})},function(){l.children("div.input").children("img").remove()})}}),o.append(i),i.hover(function(){o.parent().parent().setBackgroundPosition({x:-630})},function(){o.parent().parent().setBackgroundPosition({x:-10})}),l.children("div.select").children("span:first").text($(this).find("span").text())})}}),n(l),l.find(".inviaForm").attr("style","top: 60px")}function s(t,n,i,o){try{y.abort()}catch(a){}var s=[];return"dbpedia"==t?y=$.ajax({url:"http://lookup.dbpedia.org/api/search.asmx/PrefixSearch?QueryClass=&MaxHits=20&QueryString="+n,async:!0,success:function(e){var t=$(e);t.find("Result").each(function(){s.push({uri:$(this).children("URI").text(),label:$(this).children("Label").text()}),i()}),0==t.find("Result").length&&o()},complete:function(t,n){("error"==n||"parsererror"==n||"timeout"==n)&&(e(lang("enpointNotAvailableOrSLow")+"<br />https://lookup.dbpedia.org ("+n+")"),o())}}):"freebase"==t&&(y=$.ajax({url:"https://www.googleapis.com/freebase/v1/search?query="+n+'&mql_output={"id":null,"name":null}&lang=en&key=AIzaSyBtTcMfVJVhjmhh_MdzeBCnuIC4J0WzPXQ',async:!0,success:function(e){for(var t=0;t<e.result.length;t++){var n=e.result[t];s.push({uri:"http://rdf.freebase.com/ns/"+n.id.replace(/^\//,"").replace(/\//g,"."),label:n.name?n.name:n.id}),i()}},complete:function(t,n){("error"==n||"parsererror"==n||"timeout"==n)&&(e(lang("enpointNotAvailableOrSLow")+"<br />https://www.googleapis.com/freebase ("+n+")"),o())}})),s}var r="spriteHome";"en"==$.jStorage.get("selectedLanguage")?r="spriteHomeEn":"fr"==$.jStorage.get("selectedLanguage")&&(r="spriteHomeFr");var l=500,d=100,c=$(location).attr("search"),p=$(location).attr("hash");if(c){$("#startPanel").remove(),$(".paginator").remove(),$("#footer").remove(),$("#lang").remove(),$("body").append('<div id="aSpace"></div>');var u=$.trim(c.substring(c.indexOf("?")+1));p&&(u+=p),u=u.replace(/%2F/g,"/"),u=u.replace(/%3A/g,":"),u=u.replace(/%23/g,"#"),$("#aSpace").lodlive("init",u)}else{var v=0;$.each($.jStorage.get("profile").connection,function(){v++});var f=310*(v+1),h=(f/930+"").indexOf(".")>0?parseInt(f/930+"".replace(/\.[0-9]*/,""))+1:f/930;$("#boxesCont").width(930*h),$("#nextPage,#prevPage").click(function(){var e=$("#boxesCont").not(":animated"),t="nextPage"==$(this).attr("id");if(1==e.length){$(".hdPage:visible").hide(),$(".selectionList").remove();var n={},i=parseInt(e.css("marginLeft").replace(/px/g,""),10);t?(n={marginLeft:-930+i+"px"},0==i?$("#prevPage:hidden").fadeIn("fast"):$("#boxesCont").css("marginLeft").replace(/[-px]/g,"")==930*(h-2)&&$("#nextPage:visible").fadeOut("fast")):(n={marginLeft:930+i+"px"},-930==i?$("#prevPage:visible").fadeOut("fast"):$("#nextPage:hidden").fadeIn("fast")),e.fadeTo(d,.8,function(){e.animate(n,l,function(){e.fadeTo(d,1,function(){l=500,d=100})})})}});var g='<form><div class="select"><span>'+lang("choose")+'</span><span class="'+r+' arrow"></span></div><div class="input"><input type="text" name="startFrom" value="" readonly="readonly"/></div></form>';$.each($.jStorage.get("profile").connection,function(t,n){var i=n.examples,o=$('<div class="startBox '+r+'" rel="'+t+'"><h1><span>'+t.replace(/,.*/g,"").replace(/http:\/\//gi,"")+'</span><span class="'+r+' info"></span></h1></div>');$("#startPanel").children("#boxes").children("#boxesCont").append(o);var a=n.description[$.jStorage.get("selectedLanguage")];a||(a=n.description.en);var s=$('<div class="startBox infoHome hdPage" rel="'+t+'"><h1><span>'+t.replace(/,.*/g,"").replace(/http:\/\//gi,"")+"</span></h1><p>"+a+"</p></div>");$("#startPanel").children("#boxes").children("#boxesCont").append(s);var l=$(g);o.append(l),o.children("h1").children("span").click(function(){s.css({position:"absolute",top:o.position().top,left:o.position().left}),s.fadeIn("fast"),$("div.selectionList",l).length>0&&l.find("div.select").click()}),s.click(function(){s.fadeOut("fast")}),l.bind("submit",function(){var t=$(this).find("input[name=startFrom]").val();return""!=t?document.location="?"+$.trim(t):e(lang("impostaUnaURI")),!1}),l.find("div.select").click(function(){if($(this).data("show"))$("div.selectionList",l).remove(),$(this).data("show",!1);else{$(this).data("show",!0);var e=$(this),t=$('<div class="selectionList"></div>');if(l.append(t),t.append('<div class="selectEle" rel="inserisci"><span>'+lang("addUri")+"</span></div>"),t.append('<div class="selectEle" rel="cerca"><span>'+lang("findResource")+"</span></div>"),i)for(var n=0;n<i.length;n++)t.append('<div class="selectEle" rel="'+i[n].uri+'"><span>'+lang("example")+" - "+i[n].label+"</span></div>");t.hover(function(){},function(){e.click()}),l.find(".selectEle").click(function(){e.click();var t=$(this).attr("rel");if("cerca"==t){if(l.parent().setBackgroundPosition({y:-320}),0==$("div.cerca",l).length){var n=$('<div class="cerca"><div class="select"><span>'+lang("choose")+'</span><span class="'+r+' arrow"></span></div><div class="inputClass"><input type="text" name="classFrom" value="" readonly="readonly"/></div></div>');l.find("input[name=startFrom]").val("").attr("readonly","readonly").css({background:"#bdbdbd",color:"#575757"}).parent().css({background:"#bdbdbd"}).before(n),l.find(".inviaForm").attr("style","top: 20px;");var i=$('<div class="selectionList" style="display:none"></div>'),o='<div class="selectEle" ><span>{CONTENT}</span></div>';$("#aSpace").lodlive("allClasses",l.parent().attr("rel"),n.find("div.select > span:first"),i,o),n.find("div.select").click(function(){if($(this).data("show"))$(".slimScrollDiv",n).remove(),$(this).data("show",!1);else{$(this).data("show",!0),n.append(i);var e=$(this);n.find(".selectEle").click(function(){e.click();var t=$(this).text();e.find("span:first").text(t),n.find("input[name=classFrom]").val("").removeAttr("readonly").css({background:"#fff",color:"#000"}).focus().parent().css({background:"#fff"})});var t=$('<div class="inviaForm2"></div>');0!=n.find(".inviaForm2").length&&n.find(".inviaForm2").remove(),t.click(function(){$("#aSpace").lodlive("findSubject",l.parent().attr("rel"),"http://"+e.find("span:first").text(),n.find("input[name=classFrom]").val(),l.find("input[name=startFrom]"),l.find("input[name=startFrom]"))}),n.append(t),t.hover(function(){n.parent().parent().setBackgroundPosition({x:-630})},function(){n.parent().parent().setBackgroundPosition({x:-10})}),$(".slimScrollDiv",n).remove(),i.css({display:"block"}),i.slimScroll({height:160,width:260,color:"#000"}),$(".slimScrollDiv",n).css({position:"absolute",display:"block",left:e.position().left,top:e.position().top+60}),$(".slimScrollDiv",n).hover(function(){},function(){e.click()})}})}}else"inserisci"==t?(l.find("input[name=startFrom]").val("").removeAttr("readonly").css({background:"#fff",color:"#575757"}).focus().parent().css({background:"#fff"}),$(".cerca",l).remove(),l.find(".inviaForm").attr("style",""),l.parent().setBackgroundPosition({y:-10})):(l.find("input[name=startFrom]").attr("readonly","readonly").css({background:"#bdbdbd",color:"#575757"}).val(t).parent().css({background:"#bdbdbd"}),$(".cerca",l).remove(),l.find(".inviaForm").attr("style",""),l.parent().setBackgroundPosition({y:-10}));l.find("div.select > span:first").text($(this).find("span").text())}),t.css({position:"absolute",zIndex:"9999",left:e.position().left,top:e.position().top+60})}});var d=$('<div class="inviaForm"></div>');d.click(function(){l.submit()}),l.append(d),d.hover(function(){$(this).parent().parent().setBackgroundPosition({x:-320})},function(){$(this).parent().parent().setBackgroundPosition({x:-10})})});var m=$("#firstLineBoxes");o($("#startPanel").children("#boxes").children("#boxesCont")),a(m,g),i(m,g),m.append('<div class="startBox '+r+'" id="boxV"><h1><span>'+lang("insertData")+'</span><span class="'+r+' info"></span></h1></div>'),$("#menu").find("a[href^=#]").click(function(){var e=$('<div class="text '+r+'"><h3>'+$(this).text()+'</h3><div class="padding">'+$($(this).attr("href")).children("p").html()+"</div></div>");return e.click(function(){$(this).remove()}),$(".text").length>0&&$(".text").remove(),$("body").append(e),!1})}$.support.canvas||e(lang("noIe"));var y=null}),function($){function hashFunc(e){if(!e)return e;for(var t=0,n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t&=t;return t}function LodLiveProfile(){}function LodLive(e){this.profile=e}var jwin=$(window),jbody=$(document.body);$.ajaxSetup({contentType:"application/json",dataType:"jsonp"});var DEFAULT_BOX_TEMPLATE='<div class="boxWrapper defaultBoxTemplate" id="first"><div class="box sprite"></div></div>';LodLive.shortenKey=function(e){e=jQuery.trim(e);var t=e.lastIndexOf("/"),n=e.lastIndexOf("#");return e.substring(t>n?t+1:n+1)},LodLive.prototype.init=function(e,t){var n,i=this;if(console.log("initializing LodLive",e,t),"string"==typeof t?(n=t,t={}):n=t.firstUri,"string"==typeof e&&(e=jQuery(e)),!e.length)throw"LodLive: no context found";this.debugOn=t.debugOn&&window.console,this.context=e,this.imagesMap={},this.mapsMap={},this.infoPanelMap={},this.connection={},this.hashFunc=t.hashFunc||hashFunc,this.innerPageMap={},this.storeIds={},this.boxTemplate=this.profile.boxTemplate||DEFAULT_BOX_TEMPLATE,this.ignoreBnodes=t.ignoreBnodes;var o=$(this.boxTemplate);this.centerBox(o),o.attr("id",this.hashFunc(n)),o.attr("rel",n),o.css("zIndex",1),e.append(o),this.classMap={counter:Math.floor(13*Math.random())+1},this.renewDrag(e.children(".boxWrapper")),this.openDoc(n,o),this.controlPanel("init"),this.msg("","init"),jwin.bind("scroll",function(){i.docInfo(null,"move"),i.controlPanel("move")}),jwin.bind("resize",function(){i.docInfo("","close"),i.controlPanelDiv.remove(),i.controlPanel("init")})},LodLive.prototype.controlPanel=function(e){var t=this,n=t.controlPanelDiv;this.debugOn&&(start=(new Date).getTime()),"init"==e?(n=$('<div class="lodLiveControlPanel"></div>'),t.controlPanelDiv=n,n.css({left:0,top:10,position:"fixed",zIndex:999}),n.append('<div class="lodlive-panel lodlive-panel-options sprite" ></div>'),n.append('<div class="lodlive-panel lodlive-panel-legend sprite" ></div>'),n.append('<div class="lodlive-panel lodlive-panel-help sprite" ></div>'),n.append('<div class="lodlive-panel lodlive-panel-main" ></div>'),n.append('<div class="lodlive-panel2 lodlive-panel-maps sprite" ></div>'),n.append('<div class="lodlive-panel2 lodlive-panel-images sprite" ></div>'),n.children(".lodlive-panel-main,.lodlive-panel-panel2").hover(function(){$(this).setBackgroundPosition({y:-450})},function(){$(this).setBackgroundPosition({y:-400})}),this.context.append(n),n.attr("data-top",n.position().top),n.children(".lodlive-panel").click(function(){var e=$(this);n.children(".lodlive-panel,.lodlive-panel2").hide();var i=$('<div class="lodlive-panel lodlive-panel-close sprite" ></div>');i.click(function(){i.remove(),n.children("#panelContent").remove(),n.removeClass("justX"),n.children(".lodlive-panel,.lodlive-panel2").show(),n.children(".inactive").hide()}),i.hover(function(){$(this).setBackgroundPosition({y:-550})},function(){$(this).setBackgroundPosition({y:-500})}),n.append(i),i.css({position:"absolute",left:241,top:0});var o=$('<div class="lodlive-panel lodlive-panel-content"></div>');if(n.append(o),e.is(".lodlive-panel-options")){var a=$('<ul class="lodlive-panel-options-list"></ul>');o.append("<div></div>"),o.children("div").append("<h2>"+LodLiveUtils.lang("options")+"</h2>").append(a),a.append("<li "+(t.doInverse?'class="checked"':'class="check"')+' data-value="inverse" ><span class="spriteLegenda"></span>'+LodLiveUtils.lang("generateInverse")+"</li>"),a.append("<li "+(t.doAutoExpand?'class="checked"':'class="check"')+' data-value="autoExpand" ><span class="spriteLegenda"></span>'+LodLiveUtils.lang("autoExpand")+"</li>"),a.append("<li "+(t.doAutoSameas?'class="checked"':'class="check"')+' data-value="autoSameas"><span class="spriteLegenda"></span>'+LodLiveUtils.lang("autoSameAs")+"</li>"),a.append("<li "+(t.doCollectImages?'class="checked"':'class="check"')+' data-value="autoCollectImages"><span class="spriteLegenda"></span>'+LodLiveUtils.lang("autoCollectImages")+"</li>"),a.append("<li "+(t.doDrawMap?'class="checked"':'class="check"')+' data-value="autoDrawMap"><span class="spriteLegenda"></span>'+LodLiveUtils.lang("autoDrawMap")+"</li>"),a.append("<li>&#160;</li>"),a.append('<li class="reload"><span  class="spriteLegenda"></span>'+LodLiveUtils.lang("restart")+"</li>"),a.children(".reload").click(function(){context.lodlive("close")}),a.children("li[data-value]").click(function(){var e=$(this),i=e.data("value"),a=e.is(".check, :checked");if(e.is(".check")){switch(i){case"inverse":t.doInverse=a;break;case"autoExpand":t.doInverse=a;break;case"autoSameas":t.doAutoSameas=a;break;case"autoCollectImages":t.doCollectImages=a,n.children("div.lodlive-panel-images").toggleClass("inactive");break;case"autoDrawMap":t.doDrawMap=a,n.children("div.lodlive-panel-maps").toggleClass("inactive")}e.toggleClass("checked")}else if(e.is(".help")){var s=n.find(".lodlive-panel-help").children("div").clone();$(".videoHelp",s).fancybox({transitionIn:"elastic",transitionOut:"elastic",speedIn:400,type:"iframe",width:853,height:480,speedOut:200,hideOnContentClick:!1,showCloseButton:!0,overlayShow:!1}),o.append(s),s.height()>jwin.height()+10&&n.addClass("justX")}else if(e.is(".legend")){var r=n.find(".legenda").children("div").clone(),l=0;r.find("span.spriteLegenda").each(function(){$(this).css({"background-position":"-1px -"+20*l+"px"}),l++}),o.append(r),r.height()>jwin.height()+10&&n.addClass("justX")}})}t.doCollectImages||n.children("div.lodlive-panel-images").addClass("inactive").hide(),t.doDrawMap||n.children("div.lodlive-panel-maps").addClass("inactive").hide(),n.on("click",".lodlive-panel2",function(){var i=$(this);n.children(".lodlive-panel,.lodlive-panel2").hide();var a=$('<div class="lodlive-panel lodlive-close2 sprite" ></div>');a.click(function(){$(this).remove(),n.find(".lodlive-maps-container, .lodlive-images-container, .inactive").hide(),o.hide(),n.removeClass("justX"),n.children(".lodlive-panel,.lodlive-panel2").show()}),a.hover(function(){$(this).setBackgroundPosition({y:-550})},function(){$(this).setBackgroundPosition({y:-500})}),n.append(a);var s=n.find(".lodlive-panel2-content");if(s.length?s.show():(s=$('<div class="lodlive-panel2-content"></div>'),n.append(s)),i.is(".maps")){var r=s.find(".lodlive-maps-container");r.length?r.show():(r=$('<div class="lodlive-maps-container"></div>'),s.width(800),s.append(r),r.gmap3({action:"init",options:{zoom:2,mapTypeId:google.maps.MapTypeId.HYBRID}})),t.updateMapPanel(n)}else if(e.is(".images")){var l=panel2Contet.find(".lodlive-images-container");l.length?l.show():(l=$('<div class="lodlive-images-container"><span class="lodlive-images-count"></span></div>'),s.append(l)),t.updateImagePanel(n)}})})):"move"===e&&(n.is(".justX")?n.css({position:"absolute",left:jbody.scrollLeft(),top:n.data("top")}):(n.css({left:0,top:10,position:"fixed"}),n.position()&&n.data("top",n.position().top))),t.debugOn&&console.debug((new Date).getTime()-start+"  controlPanel ")},LodLive.prototype.close=function(){document.location=document.location.pathname},LodLive.prototype.composeQuery=function(e,t,n){var i,o,a,s=this,r=s.profile;return s.debugOn&&(start=(new Date).getTime()),jQuery.each(r.connection,function(l,d){for(var c=l.split(","),p=0;p<c.length;p++)if(0===(n?n:e).indexOf(c[p]))return o=LodLiveUtils.getSparqlConf(t,d,r).replace(/\{URI\}/gi,e.replace(/^.*~~/,"")),i=d.proxy?d.proxy+"?endpoint="+d.endpoint+"&"+(d.endpointType?s.profile.endpoints[d.endpointType]:s.profile.endpoints.all)+"&query="+encodeURIComponent(o):d.endpoint+"?"+(d.endpointType?s.profile.endpoints[d.endpointType]:s.profile.endpoints.all)+"&query="+encodeURIComponent(o),a=d.endpoint,!1}),s.debugOn&&console.debug((new Date).getTime()-start+"  composeQuery "),i||(i="http://system/dummy?"+e),a&&s.showInfoConsole&&s.queryConsole("log",{title:a,text:o,id:i,uriId:e}),i},LodLive.prototype.guessingEndpoint=function(e,t,n){var i=e.replace(/(^http:\/\/[^\/]+\/).+/,"$1"),o=this,a=i+"sparql?"+o.profile.endpoints.all+"&query="+encodeURIComponent("select * where {?a ?b ?c} LIMIT 1");$.ajax({url:a,success:function(e){e&&e.results&&e.results.bindings[0]?(o.connections[i]={endpoint:i+"sparql"},t()):n()},error:function(){o.debugOn&&console.log("guessingEndpointError",arguments),n()}})},LodLive.prototype.msg=function(e,t,n,i,o){var a,s=this,r=s.context.find(".lodlive-message-container");switch(e||(e=""),t){case"init":r.length||(r=$('<div class="lodlive-message-container"></div>'),s.context.append(r));break;case"move":r.hide(),r.css({display:"none"});break;case"hide":r.hide()}r.empty(),e=e.replace(/http:\/\/.+~~/g,""),e=e.replace(/nodeID:\/\/.+~~/g,""),e=e.replace(/_:\/\/.+~~/g,""),e=breakLines(e),e=e.replace(/\|/g,"<br />"),a=e.split(" \n "),"fullInfo"===n?(r.append('<div class="corner sprite"></div>'),r.append('<div class="endpoint">'+i+"</div>"),2===a.length?(r.append('<div class="separline sprite"></div>'),r.append('<div class="from upperline">'+(a[0].length>200?a[0].substring(0,200)+"...":a[0])+"</div>"),r.append('<div class="separline sprite"></div>'),r.append('<div class="from upperline">'+a[1]+"</div>")):(r.append('<div class="separline sprite"></div>'),r.append('<div class="from upperline">'+a[0]+"</div>"))):2===a.length?(r.append('<div class="from">'+a[0]+"</div>"),r.append(o?'<div class="separ inverse sprite"></div>':'<div class="separ sprite"></div>'),r.append('<div class="from">'+a[1]+"</div>")):r.append('<div class="from">'+a[0]+"</div>"),r.css({left:0,top:jwin.height()-r.height(),position:"fixed",zIndex:99999999}),r.show()},LodLive.prototype.queryConsole=function(e,t){var n=this,i=n.hashFunc(t.uriId),o=n.hashFunc(t.id),a=n.infoPanelMap,s=a[i];switch(e){case"init":s=n.context.find('<div id="q'+i+'" class="lodlive-query-console"></div>'),a[i]=s,n.infoPanelMap=a;break;case"log":if(s&&t){if(t.resource&&(s.append('<h3 class="sprite"><span>'+t.resource+'</span><a class="sprite">&#160;</a></h3>'),s.on("click","h3 a",function(){n.queryConsole("close",{uriId:t.uriId})}).hover(function(){$(this).setBackgroundPosition({x:-641})},function(){$(this).setBackgroundPosition({x:-611})})),t.title){var r=$('<h4 class="t'+o+' sprite"><span>'+t.title+"</span></h4>");s.append(r),r.hover(function(){r.setBackgroundPosition({y:-700})},function(){r.setBackgroundPosition({y:-650})}),r.click(function(){r.data("show")?(r.data("show",!1),r.setBackgroundPosition({x:-680}),r.removeClass("slideOpen"),r.next("div").slideToggle()):(r.data("show",!0),r.setBackgroundPosition({x:-1290}),s.find(".slideOpen").click(),r.addClass("slideOpen"),r.next("div").slideToggle())})}if(t.text){var l=$('<div><span><span class="contentArea">'+t.text.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span></span></div>"),d=$.trim(s.find("h4.t"+o).clone().find("strong").remove().end().text());if(0===d.indexOf("http:")){var c=$('<span class="linkArea sprite" title="'+LodLiveUtils.lang("executeThisQuery")+'"></span>');c.click(function(){window.open(d+"?query="+encodeURIComponent(t.text))}),c.hover(function(){c.setBackgroundPosition({x:-630})},function(){c.setBackgroundPosition({x:-610})}),l.children("span").prepend(c)}l.css({opacity:.95}),s.append(l)}t.error&&s.find("h4.t"+o+" > span").append('<strong style="float:right">'+LodLiveUtils.lang("enpointNotAvailable")+"</strong>"),"number"==typeof t.founded&&s.find("h4.t"+o+" > span").append(t.founded?'<strong style="float:right">'+t.founded+" "+LodLiveUtils.lang("propsFound")+" </strong>":'<strong style="float:right">'+LodLiveUtils.lang("propsNotFound")+"</strong>"),a[i]=s,globalInfoPanelMap=a}break;case"remove":delete a[i],n.infoPanelMap=a;break;case"show":n.context.append(s);break;case"close":s.detach()}},LodLive.prototype.updateMapPanel=function(e){var t,n=this;if(n.doDrawMap)if(t=n.context.find(".lodlive-maps-container"),t.length&&t.is(":visible")){t.gmap3({action:"clear"});var i=n.context.find(".lodlive-panel2-content");i.width(800);for(var o=e.find(".lodlive-close2"),a=n.mapsMap,s=Object.keys(a),r=s.length,l=r>1?{action:"autofit"}:{};r--;){var d=s[r];$("#mapPanel").gmap3({action:"addMarker",latLng:[a[d].lats,a[d].longs],title:unescape(a[d].title)},l)}o.css({position:"absolute",left:i.width()+1,top:0})}else n.highlight(e.children(".maps"),2,200,"-565px -450px")},LodLive.prototype.updateImagePanel=function(e){var t=this;if(t.doCollectImages){var n=e.find(".lodlive-images-container span:visible");if(n.length){var i=e.find(".lodlive-panel2-content"),o=e.find(".lodlive-close2"),a=t.imagesMap,s=Object.keys(a),r=s.length;if(r>0){n.children(".amsg").remove();for(var l=0;r--;)for(var d=s[r],c=0;c<a[d].length;c++)for(var p in a[d][c]){if(t.noImagesMap[d+l])l--;else if(!n.children(".img-"+d+"-"+l).length){var u=$('<a href="'+unescape(p)+'" class="sprite relatedImage img-'+d+"-"+l+'"><img rel="'+unescape(a[d][c][p])+'" src="'+unescape(p)+'"/></a>"');u.attr("data-prop",d),n.prepend(u),u.fancybox({transitionIn:"elastic",transitionOut:"elastic",speedIn:400,type:"image",speedOut:200,hideOnContentClick:!0,showCloseButton:!1,overlayShow:!1}),u.children("img").error(function(){if(u.remove(),l--,3>l)i.width(148);else{var e=(l/3+(l%3>0?1:0)+"").split(".")[0];e>7&&(e=7),i.width(20+128*e)}o.css({position:"absolute",left:i.width()+1,top:0}),t.noImagesMap[d+l]=!0}).load(function(){var n=$(this),a=n.attr("rel"),s=n.width(),r=n.height();r>s?(n.height(113*r/s),n.width(113)):n.css({width:113*s/r,height:113,marginLeft:-((113*s/r-113)/2)});var d=$('<span class="lodlive-image-controls"><span class="imgControlCenter" title="'+LodLiveUtils.lang("showResource")+'"></span><span class="imgControlZoom" title="'+LodLiveUtils.lang("zoomIn")+'"></span><span class="imgTitle">'+a+"</span></span>");if(u.append(d),u.hover(function(){n.hide()},function(){n.show()}),d.children(".imgControlZoom").hover(function(){u.setBackgroundPosition({x:-1955})},function(){u.setBackgroundPosition({x:-1825})}),d.children(".imgControlCenter").hover(function(){u.setBackgroundPosition({x:-2085})},function(){u.setBackgroundPosition({x:-1825})}),d.children(".imgControlCenter").click(function(){return e.find(".lodlive-close2").click(),t.highlight($("#"+u.attr("data-prop")).children(".box"),8,100,"0 0"),!1}),3>l)i.width(148);else{var c=(l/3+(l%3>0?1:0)+"").split(".")[0];c>7&&(c=7),i.width(20+128*c),o.css({position:"absolute",left:i.width()+1,top:0})}})}l++}}else i.width(148),n.children(".amsg").length||n.append('<span class="amsg">'+LodLiveUtils.lang("imagesNotFound")+"</span>");o.css({position:"absolute",left:i.width()+1,top:0})}else t.highlight(e.children(".images"),2,200,"-610px -450px")}},LodLive.prototype.highlight=function(e,t,n,i){var o=this;if(t>0){t--;var a=e.css("background-position");e.doTimeout(n,function(){e.css({"background-position":i}),e.doTimeout(n,function(){e.css({"background-position":a}),o.highlight(e,t,n,i)})})}},LodLive.prototype.renewDrag=function(e){var t,n=this;n.debugOn&&(start=(new Date).getTime()),e.each(function(){var e=$(this),i=e.attr("id");e.is(".ui-draggable")||e.draggable({stack:".boxWrapper",containment:"parent",start:function(){n.context.find(".lodlive-toolbox").remove(),$("#line-"+i).clearCanvas();var e=n.storeIds["rev"+i];if(e)for(var o=0;o<e.length;o++)t=n.storeIds["gen"+e[o]],$("#line-"+e[o]).clearCanvas()},drag:function(){},stop:function(){n.drawAllLines($(this))}})}),n.debugOn&&console.debug((new Date).getTime()-start+"  renewDrag ")},LodLive.prototype.centerBox=function(e){{var t,n=this,i=n.context.height(),o=n.context.width();e.width()||65,e.height()||65}n.debugOn&&(t=(new Date).getTime());var a=(i-65)/2+(n.context.scrollTop()||0),s=(o-65)/2+(n.context.scrollLeft()||0),r={position:"absolute",left:s,top:a};try{e.animate(r,1e3)}catch(l){e.css(r)}n.debugOn&&console.debug((new Date).getTime()-t+"  centerBox ")},LodLive.prototype.autoExpand=function(){var e,t=this;t.debugOn&&(e=(new Date).getTime()),$.each(t.innerPageMap,function(e,n){var i=n.children(".relatedBox:not([class*=exploded])");i.length&&(n.parent().length||t.context.append(n),i.each(function(){box=$(moreInfoOnThis);var e=box.attr("relmd5"),n=t.context.children("#"+e);n.length>0&&box.click()}),t.context.children(".innerPage").detach())}),t.context.find(".relatedBox:not([class*=exploded])").each(function(){var e=$(this),t=e.attr("relmd5"),n=context.children("#"+t);n.length>0&&e.click()}),t.debugOn&&console.debug((new Date).getTime()-e+"  autoExpand ")},LodLive.prototype.addNewDoc=function(e,t,n){var i,o=this;o.debugOn&&(i=(new Date).getTime());var a=t.attr("relmd5"),s=o.context.find("#"+a),r=t.is(".inverse"),l=!0;t=$(t),s.length||(s=$(o.boxTemplate),l=!1);var d=t.data("circleid"),c=$("#"+d);if(o.debugOn&&console.debug((new Date).getTime()-i+"  addNewDoc 01 "),!r){o.debugOn&&console.debug((new Date).getTime()-i+"  addNewDoc 02 ");var p=o.storeIds["gen"+d];if(p){if(-1!=$.inArray(a,p))return;p.push(a)}else p=[a];o.debugOn&&console.debug((new Date).getTime()-i+"  addNewDoc 03 "),o.storeIds["gen"+d]=p,p=o.storeIds["rev"+a],p?-1==$.inArray(d,p)&&p.push(d):p=[d],o.debugOn&&console.debug((new Date).getTime()-i+"  addNewDoc 04 "),o.storeIds["rev"+a]=p}var u=t.data("property"),v=t.attr("rel");s.attr("id",a),s.attr("rel",v);var f=r?'div[data-property="'+u+'"][rel="'+v+'"]':null;if(o.debugOn&&console.debug((new Date).getTime()-i+"  addNewDoc 05 "),t.hide(),l)r?o.debugOn&&console.debug((new Date).getTime()-i+"  addNewDoc 11 "):(o.debugOn&&console.debug((new Date).getTime()-i+"  addNewDoc 10 "),o.renewDrag(o.context.children(".boxWrapper")),o.drawaLine(e,s,u));else{o.debugOn&&console.debug((new Date).getTime()-i+"  addNewDoc 06 ");var h=parseInt(t.attr("data-circlePos"),10),g=parseInt(t.attr("data-circleParts"),10),m=o.circleChords(g>10?h%2>0?3*c.width():2*c.width():5*c.width()/2,g,c.position().left+e.width()/2,c.position().top+c.height()/2,null,h);o.context.append(s),s.css({left:m[0][0]-s.height()/2,top:m[0][1]-s.width()/2,opacity:1,zIndex:99}),o.renewDrag(o.context.children(".boxWrapper")),o.debugOn&&console.debug((new Date).getTime()-i+"  addNewDoc 07 "),r?(debugOn&&console.debug((new Date).getTime()-i+"  addNewDoc 09 "),o.openDoc(v,s,f)):(o.debugOn&&console.debug((new Date).getTime()-i+"  addNewDoc 08 "),o.doInverse?o.openDoc(v,s,f):o.openDoc(v,s),o.drawaLine(e,s,u))}return n&&n(),o.debugOn&&console.debug((new Date).getTime()-i+"  addNewDoc "),!1},LodLive.prototype.removeDoc=function(e){var t=this;t.debugOn&&(start=(new Date).getTime()),t.context.find(".lodlive-toolbox").remove();var n=e.attr("id");t.queryConsole("remove",{uriId:e.attr("rel")}),t.context.find("#line-"+n).clearCanvas();var i=t.storeIds["rev"+n];if(i)for(var o=0;o<i.length;o++)t.context.find("#line-"+i[o]).clearCanvas();t.docInfo("","close");var a=t.context.find(".lodLiveControlPanel");if(t.doCollectImages){var s=t.imagesMap;s[n]&&(delete s[n],t.updateImagePanel(a),a.find("a[class*=img-"+n+"]").remove())}if(t.doDrawMap){var r=t.mapsMap;r[n]&&(delete r[n],t.updateMapPanel(a))}e.fadeOut("normal",null,function(){e.remove(),$.each(t.innerPageMap,function(e,i){if(i.children("."+n).length){var o=t.context.find("#"+e);
o.append(i);var a=o.find(".lastClick").attr("rel");o.children(".innerPage").children("."+a).length||o.children(".innerPage").detach()}}),t.context.find("."+n).each(function(){var e=$(this);e.show(),e.removeClass("exploded")});var i,o,a,s=t.storeIds["gen"+n],r=t.storeIds["rev"+n];if(r)for(i=0;i<r.length;i++)if(a=t.storeIds["gen"+r[i]])for(o=0;o<a.length;o++)a[o]===n&&a.splice(o,1);if(s)for(i=0;i<s.length;i++)if(a=t.storeIds["rev"+s[i]])for(o=0;o<a.length;o++)a[o]==n&&a.splice(o,1);if(r=t.storeIds["rev"+n])for(i=0;i<r.length;i++)if(s=t.storeIds["gen"+r[i]])for(o=0;o<s.length;o++)t.drawaLine(t.context.find("#"+r[i]),t.context.find("#"+s[o]));delete t.storeIds["rev"+n],delete t.storeIds["gen"+n]}),t.debugOn&&console.debug((new Date).getTime()-start+"  removeDoc ")},LodLive.prototype.addClick=function(e,t){var n=this;n.debugOn&&(start=(new Date).getTime()),e.find(".relatedBox").each(function(){var t=$(this);t.attr("relmd5",n.hashFunc(t.attr("rel"))),t.click(function(i){t.addClass("exploded"),n.addNewDoc(e,t),i.stopPropagation()}),t.hover(function(){n.msg(t.data("title"),"show",null,null,t.is(".inverse"))},function(){n.msg(null,"hide")})}),e.find(".groupedRelatedBox").each(function(){var t=$(this);t.click(function(){t.data("show")?(t.data("show",!1),n.docInfo("","close"),t.removeClass("lastClick"),e.find("."+t.attr("rel")).fadeOut("fast"),t.fadeTo("fast",1),e.children(".innerPage").detach()):(t.data("show",!0),e.append(n.innerPageMap[e.attr("id")]),n.docInfo("","close"),e.find(".lastClick").removeClass("lastClick").click(),e.children(".innerPage").length||e.append(n.innerPageMap[e.attr("id")]),t.addClass("lastClick"),e.find("."+t.attr("rel")+":not([class*=exploded])").fadeIn("fast"),t.fadeTo("fast",.3))}),t.hover(function(){n.msg(t.attr("data-title"),"show",null,null,t.is(".inverse"))},function(){n.msg(null,"hide")})}),n.innerPageMap[e.attr("id")]=e.children(".innerPage"),e.children(".innerPage").detach(),e.find(".actionBox[rel=contents]").click(function(){n.docInfo(e,"open")}),e.find(".actionBox[rel=tools]").click(function(){if(n.context.find(".toolBox:visible").length)n.context.find(".toolBox").fadeOut("fast",null,function(){$(".toolBox").remove()});else{var t=e.position(),i=$('<div class="lodlive-toolbox sprite" style="display:none" ><div class="innerActionBox infoQ" rel="infoQ" title="'+LodLiveUtils.lang("moreInfoOnThis")+'" >&#160;</div><div class="innerActionBox center" rel="center" title="'+LodLiveUtils.lang("centerClose")+'" >&#160;</div><div class="innerActionBox newpage" rel="newpage" title="'+LodLiveUtils.lang("openOnline")+'" >&#160;</div><div class="innerActionBox expand" rel="expand" title="'+LodLiveUtils.lang("openRelated")+'" >&#160;</div><div class="innerActionBox remove" rel="remove" title="'+LodLiveUtils.lang("removeResource")+'" >&#160;</div></div>');n.context.append(i),i.css({top:t.top-23,left:t.left+10}),i.fadeIn("fast"),i.find(".innerActionBox[rel=expand]").each(function(){var t=$(this);t.click(function(){function t(){var e=a.eq(o++);e.length&&e.click(),s>o&&window.setTimeout(t,75)}i.remove(),n.docInfo("","close");var o=0,a=e.find(".relatedBox:visible"),s=a.length;window.setTimeout(t,75)}),t.hover(function(){i.setBackgroundPosition({y:-515})},function(){i.setBackgroundPosition({y:-395})})}),i.find(".innerActionBox[rel=infoQ]").each(function(){var t=$(this);t.click(function(){i.remove(),n.queryConsole("show",{uriId:e.attr("rel")})}),t.hover(function(){i.setBackgroundPosition({y:-425})},function(){i.setBackgroundPosition({y:-395})})}),i.find(".innerActionBox[rel=remove]").each(function(){var t=$(this);t.click(function(){n.removeDoc(e),i.remove(),n.docInfo("","close")}),t.hover(function(){i.setBackgroundPosition({y:-545})},function(){i.setBackgroundPosition({y:-395})})}),i.find(".innerActionBox[rel=newpage]").each(function(){var t=$(this);t.click(function(){i.remove(),n.docInfo("","close"),window.open(e.attr("rel"))}),t.hover(function(){t.parent().setBackgroundPosition({y:-485})},function(){t.parent().setBackgroundPosition({y:-395})})}),i.find(".innerActionBox[rel=center]").each(function(){var t=$(this);t.click(function(){var t=$(location).attr("href");-1!=t.indexOf("?http")&&(document.location=t.substring(0,t.indexOf("?"))+"?"+e.attr("rel"))}),t.hover(function(){i.setBackgroundPosition({y:-455})},function(){i.setBackgroundPosition({y:-395})})})}}),t&&t(),n.debugOn&&console.debug((new Date).getTime()-start+"  addClick ")},LodLive.prototype.parseRawResourceDoc=function(destBox,URI){var inst=this;inst.debugOn&&(start=(new Date).getTime());var uris=[],bnodes=[],values=[],def=inst.profile["default"];if(def){var res=LodLiveUtils.getSparqlConf("document",def,inst.profile).replace(/\{URI\}/gi,URI),url=def.endpoint+"?uri="+encodeURIComponent(URI)+"&query="+encodeURIComponent(res);inst.showInfoConsole&&inst.queryConsole("log",{title:LodLiveUtils.lang("endpointNotConfiguredSoInternal"),text:res,uriId:URI}),$.ajax({url:url,beforeSend:function(){inst.context.append(destBox),destBox.html('<img style="margin-left:'+destBox.width()/2+'px;margin-top:147px" src="img/ajax-loader-gray.gif"/>'),destBox.css({position:"fixed",right:20,top:0}),destBox.attr("data-top",destBox.position().top)},success:function(json){json=json.results&&json.results.bindings,$.each(json,function(key,value){eval("uri"===value.object.type?"uris.push({'"+value.property.value+"':'"+escape(value.object.value)+"'})":"bnode"==value.object.type?"bnodes.push({'"+value.property.value+"':'"+escape(value.object.value)+"'})":"values.push({'"+value.property.value+"':'"+escape(value.object.value)+"'})")}),destBox.html(""),inst.debugOn&&(console.debug(URI+"   "),console.debug(values)),inst.formatDoc(destBox,values,uris,bnodes,URI)},error:function(){destBox.html(""),values=[{"http://system/msg":"risorsa non trovata: "+destBox.attr("rel")}],inst.formatDoc(destBox,values,uris,bnodes,URI)}})}inst.debugOn&&console.debug((new Date).getTime()-start+"  parseRawResourceDoc ")},LodLive.prototype.docInfo=function(obj,action){var inst=this,docInfo=inst.context.find(".lodlive-docinfo");switch(inst.debugOn&&(start=(new Date).getTime()),action){case"open":var URI=obj.attr("rel");if(docInfo.length&&(docInfo.fadeOut("fast",null,function(){docInfo.remove()}),$('.lodlive-docinfo[rel="info-'+URI+'"]').length>0))return;docInfo=$('<div class="lodlive-docinfo" rel="info-'+URI+'"></div>'),inst.context.append(docInfo);var SPARQLquery=inst.composeQuery(URI,"document"),uris=[],bnodes=[],values=[];0===SPARQLquery.indexOf("http://system/dummy")?inst.parseRawResourceDoc(docInfo,URI):$.ajax({url:SPARQLquery,beforeSend:function(){docInfo.html('<img style="margin-left:'+docInfo.width()/2+'px;margin-top:147px" src="img/ajax-loader-gray.gif"/>'),docInfo.css({position:"fixed",right:15,top:0}),docInfo.attr("data-top",docInfo.position().top)},success:function(json){json=json.results&&json.results.bindings,$.each(json,function(key,value){eval("uri"==value.object.type?"uris.push({'"+value.property.value+"':'"+escape(value.object.value)+"'})":"bnode"==value.object.type?"bnodes.push({'"+value.property.value+"':'"+escape(value.object.value)+"'})":"values.push({'"+value.property.value+"':'"+escape(value.object.value)+"'})")}),docInfo.html(""),inst.formatDoc(docInfo,values,uris,bnodes,URI)},error:function(){destBox.html(""),values=[{"http://system/msg":"risorsa non trovata: "+destBox.attr("rel")}],inst.formatDoc(docInfo,values,uris,bnodes,URI)}});break;default:docInfo.fadeOut("fast",null,function(){docInfo.remove()})}inst.debugOn&&console.debug((new Date).getTime()-start+"  docInfo ")},LodLive.prototype.processDraw=function(e,t,n,i,o,a){var s,r=this,l=r.profile;r.debugOn&&(s=(new Date).getTime());var d="",c="standardLine";if(r.context.find("#"+a).length>0){d=o.attr("data-propertyName-"+a);var p=d.split("|");d="\n";for(var u=0;u<p.length;u++){l.arrows[$.trim(p[u])]&&(c=r.profile.arrows[$.trim(p[u])]+"Line");{var v=LodLive.shortenKey(p[u]);v.lastIndexOf("#"),v.lastIndexOf("/")}-1==d.indexOf("\n"+v+"\n")&&(d+=v+"\n")}}"isSameAsLine"!==c?r.standardLine(d,e,t,n,i,o,a):LodLiveUtils.customLines(r.context,c,d,e,t,n,i,o,a),r.debugOn&&console.debug((new Date).getTime()-s+"  processDraw ")},LodLive.prototype.drawAllLines=function(e){var t,n=this,i=e.attr("id"),o=n.storeIds["gen"+i],a=n.storeIds["rev"+i];if(n.context.find("#line-"+i).clearCanvas(),o)for(t=0;t<o.length;t++)n.drawaLine(e,n.context.find("#"+o[t]));if(a)for(t=0;t<a.length;t++)if(o=n.storeIds["gen"+a[t]],$("#line-"+a[t]).clearCanvas(),o)for(var s=0;s<o.length;s++)n.drawaLine(n.context.find("#"+a[t]),n.context.find("#"+o[s]))},LodLive.prototype.drawaLine=function(e,t,n){var i,o=this;o.debugOn&&(i=(new Date).getTime());var a=e.position(),s=t.position(),r=$("#line-"+e.attr("id"));1==r.length?(n&&r.attr("data-propertyName-"+t.attr("id"),n),o.processDraw(a.left+e.width()/2,a.top+e.height()/2,s.left+t.width()/2,s.top+t.height()/2,r,t.attr("id"))):(r=$("<canvas data-propertyName-"+t.attr("id")+'="'+n+'" height="'+o.context.height()+'" width="'+o.context.width()+'" id="line-'+e.attr("id")+'"></canvas>'),o.context.append(r),r.css({position:"absolute",zIndex:"0",top:0,left:0}),o.processDraw(a.left+e.width()/2,a.top+e.height()/2,s.left+t.width()/2,s.top+t.height()/2,r,t.attr("id"))),o.debugOn&&console.debug((new Date).getTime()-i+"  drawaLine ")},LodLive.prototype.formatDoc=function(e,t,n,i,o){var a=this;a.debugOn&&(console.debug("formatDoc 0"),start=(new Date).getTime());var s=a.getJsonValue(n,"http://www.w3.org/1999/02/22-rdf-syntax-ns#type","default");e.addClass(a.getProperty("document","className",s));var r=a.getProperty("images","properties",s),l=a.getProperty("weblinks","properties",s),d=a.getProperty("document","propertiesMapper",o.replace(/(http:\/\/[^\/]+\/).+/,"$1"));Array.isArray(r)||(r=[r]),Array.isArray(l)||(l=[l]);var c="<div></div>",p=$(c),u=[];$.each(t,function(e,t){for(var n in t){var i={};i[n]=t[n],u.push(i)}}),a.debugOn&&console.debug("formatDoc 1");var v=[],f=[],h=[];$.each(n,function(e,t){for(var n in t){var i={};i[n]=t[n],"http://www.w3.org/1999/02/22-rdf-syntax-ns#type"!=n?-1!=$.inArray(n,r)?v.push(i):-1!=$.inArray(n,l)&&f.push(i):h.push(unescape(t[n]))}}),a.debugOn&&console.debug("formatDoc 2");var g=null;v.length>0&&(g=$('<div class="section" style="height:80px"></div>'),$.each(v,function(e,t){for(var n in t)g.append('<a class="relatedImage" href="'+unescape(t[n])+'"><img src="'+unescape(t[n])+'"/></a> ')})),a.debugOn&&console.debug("formatDoc 3");var m=null;f.length>0&&(m='<div class="section"><ul style="padding:0;margin:0;display:block;overflow:hidden;tex-overflow:ellipses">',$.each(f,function(e,t){for(var n in t)m+='<li><a class="relatedLink" target="_blank" data-title="'+n+" \n "+unescape(t[n])+'" href="'+unescape(t[n])+'">'+unescape(t[n])+"</a></li>"}),m+="</ul></div>"),a.debugOn&&console.debug("formatDoc 4");var y=$("<div></div>"),x=$('<div class="topSection sprite"><span>&#160;</span></div>');if(p.append(x),x.find("span").each(function(){var e=$(this);e.click(function(){a.docInfo("","close")}),e.hover(function(){x.setBackgroundPosition({y:-410})},function(){x.setBackgroundPosition({y:-390})})}),a.debugOn&&console.debug("formatDoc 5"),h.length>0){var b=$('<div class="section"><label data-title="http://www.w3.org/1999/02/22-rdf-syntax-ns#type">type</label><div></div></div>');b.find("label").each(function(){var e=$(this);e.hover(function(){a.msg(e.attr("data-title"),"show")},function(){a.msg(null,"hide")})});for(var L=0;L<h.length;L++){var w=LodLive.shortenKey(h[L]);b.children("div").append('<span title="'+h[L]+'">'+w+" </span>")}y.append(b),y.append('<div class="separ sprite"></div>')}if(a.debugOn&&console.debug("formatDoc 6"),g&&(y.append(g),y.append('<div class="separ sprite"></div>')),m){var k=$(m);k.find("a").each(function(){$(this).hover(function(){a.msg($(this).attr("data-title"),"show")},function(){a.msg(null,"hide")})}),y.append(k),y.append('<div class="separ sprite"></div>')}if(a.debugOn&&console.debug("formatDoc 7"),d?$.each(d,function(e,t){$.each(u,function(n,i){for(var o in i)if(e==o){var s=t;try{var r=$('<div class="section"><label data-title="'+o+'">'+s+"</label><div>"+unescape(i[o])+'</div></div><div class="separ sprite"></div>');r.find("label").each(function(){$(this).hover(function(){a.msg($(this).attr("data-title"),"show")},function(){a.msg(null,"hide")})}),y.append(r)}catch(l){}return!0}})}):$.each(u,function(e,t){for(var n in t){for(var i=n;i.indexOf("/")>-1;)i=i.substring(i.indexOf("/")+1);for(;i.indexOf("#")>-1;)i=i.substring(i.indexOf("#")+1);try{var o=$('<div class="section"><label data-title="'+n+'">'+i+"</label><div>"+unescape(t[n])+'</div></div><div class="separ sprite"></div>');o.find("label").each(function(){$(this).hover(function(){a.msg($(this).attr("data-title"),"show")},function(){a.msg(null,"hide")})}),y.append(o)}catch(s){}}}),i.length>0&&$.each(i,function(e,t){for(var n in t){var i=LodLive.shortenKey(n),s=$('<div class="section"><label data-title="'+n+'">'+i+'</label><span class="bnode"></span></div><div class="separ sprite"></div>');s.find("label").each(function(){$(this).hover(function(){a.msg($(this).attr("data-title"),"show")},function(){a.msg(null,"hide")})}),a.resolveBnodes(unescape(t[n]),o,s,y)}}),0==u.length&&0==i.length){var b=$('<div class="section"><label data-title="'+LodLiveUtils.lang("resourceMissingDoc")+'"></label><div>'+LodLiveUtils.lang("resourceMissingDoc")+'</div></div><div class="separ sprite"></div>');b.find("label").each(function(){$(this).hover(function(){a.msg($(this).attr("data-title"),"show")},function(){a.msg(null,"hide")})}),y.append(b)}e.append(p),e.append(y),y.find(".relatedImage").each(function(){$(this).fancybox({transitionIn:"elastic",transitionOut:"elastic",speedIn:400,type:"image",speedOut:200,hideOnContentClick:!0,showCloseButton:!1,overlayShow:!1}),$(this).find("img").each(function(){$(this).load(function(){$(this).width()>$(this).height()?($(this).height(80*$(this).height()/$(this).width()),$(this).width(80)):($(this).width(80*$(this).width()/$(this).height()),$(this).height(80))}),$(this).error(function(){$(this).attr("title",LodLiveUtils.lang("noImage")+" \n"+$(this).attr("src")),$(this).attr("src","img/immagine-vuota-"+$.jStorage.get("selectedLanguage")+".png")})})}),y.height()+40>$(window).height()?(e.find("div.separ:last").remove(),e.find("div.separLast").remove(),y.slimScroll({height:$(window).height()-40,color:"#fff"})):e.append('<div class="separLast"></div>'),a.debugOn&&console.debug((new Date).getTime()-start+"  formatDoc ")},LodLive.prototype.resolveBnodes=function(e,t,n,i){var o=this;o.debugOn&&(start=(new Date).getTime());var a=o.composeQuery(e,"bnode",t);return $.ajax({url:a,beforeSend:function(){n.find("span[class=bnode]").html('<img src="img/ajax-loader-black.gif"/>')},success:function(e){n.find("span[class=bnode]").html(""),e=e.results.bindings,$.each(e,function(e,a){var s=LodLive.shortenKey(a.property.value);if("uri"==a.object.type);else if("bnode"==a.object.type){var r=$('<span><label data-title="'+a.property.value+'"> / '+s+'</label><span class="bnode"></span></span>');r.find("label").each(function(){$(this).hover(function(){o.msg($(this).attr("data-title"),"show")},function(){o.msg(null,"hide")})}),n.find("span[class=bnode]").attr("class","").append(r),o.resolveBnodes(a.object.value,t,n,i)}else n.find("span[class=bnode]").append('<div><em title="'+a.property.value+'">'+s+"</em>: "+a.object.value+"</div>");i.append(n),i.height()+40>$(window).height()?(i.slimScroll({height:$(window).height()-40,color:"#fff"}),i.parent().find("div.separLast").remove()):i.parent().append('<div class="separLast"></div>')})},error:function(){n.find("span").html("")}}),o.debugOn&&console.debug((new Date).getTime()-start+"  resolveBnodes "),e},LodLive.prototype.circleChords=function(e,t,n,i,o,a){var s=this;s.debugOn&&(start=(new Date).getTime());var r=[],l=0;if(a){l=a;var d=2*Math.PI*(l/t);r.push([n+e*Math.cos(d),i+e*Math.sin(d)])}else for(;t>l;l++){var d=2*Math.PI*(l/t);r.push([n+e*Math.cos(d),i+e*Math.sin(d)])}return s.debugOn&&console.debug((new Date).getTime()-start+"  circleChords "),r},LodLive.prototype.getJsonValue=function(e,t,n){var i=this;i.debugOn&&(start=(new Date).getTime());var o=[];return $.each(e,function(e,n){for(var i in n)i==t&&o.push(unescape(n[i]))}),o==[]&&(o=[n]),i.debugOn&&console.debug((new Date).getTime()-start+"  getJsonValue"),o},LodLive.prototype.getProperty=function(e,t,n){var i=this,o=i.profile;if(i.debugOn&&(start=(new Date).getTime()),Array.isArray(n)){for(var a=0;a<n.length;a++)if(o[n[a]]&&o[n[a]][e])return t?o[n[a]][e][t]?o[n[a]][e][t]:o["default"][e][t]:o[n[a]][e]?o[n[a]][e]:o["default"][e]}else if(n+="",o[n]&&o[n][e])return t?o[n][e][t]?o[n][e][t]:o["default"][e][t]:o[n][e]?o[n][e]:o["default"][e];return i.debugOn&&console.debug((new Date).getTime()-start+"  getProperty"),o["default"][e]?t?o["default"][e][t]:o["default"][e]:""},LodLive.prototype.format=function(destBox,values,uris,inverses){var inst=this,classMap=inst.classMap,lodLiveProfile=inst.profile;inst.debugOn&&(start=(new Date).getTime());var containerBox=destBox.parent("div"),thisUri=containerBox.attr("rel")||"",docType=inst.getJsonValue(uris,"http://www.w3.org/1999/02/22-rdf-syntax-ns#type","default");-1!=thisUri.indexOf("~~")&&(docType="bnode");var aClass=inst.getProperty("document","className",docType);"bnode"==docType&&(aClass="bnode"),(null==aClass||"standard"==aClass||""==aClass)&&(classMap[docType]?aClass=classMap[docType]:(aClass="box"+classMap.counter,13===classMap.counter?classMap.counter=1:classMap.counter+=1,classMap[docType]=aClass)),containerBox.addClass(aClass);var titles=inst.getProperty("document","titleProperties",docType),images=inst.getProperty("images","properties",docType),weblinks=inst.getProperty("weblinks","properties",docType),lats=inst.getProperty("maps","lats",docType),longs=inst.getProperty("maps","longs",docType),points=inst.getProperty("maps","points",docType);"string"==typeof titles&&(titles=[titles]),"string"==typeof images&&(images=[images]),"string"==typeof weblinks&&(weblinks=[weblinks]),"string"==typeof lats&&(lats=[lats]),"string"==typeof longs&&(longs=[longs]),"string"==typeof points&&(points=[points]),titles.push("http://system/msg");for(var result='<div class="boxTitle"><span class="ellipsis_text">',a=0;a<titles.length;a++){var resultArray=inst.getJsonValue(values,titles[a],0==titles[a].indexOf("http")?"":titles[a]);if(0!=titles[a].indexOf("http"))-1==result.indexOf($.trim(unescape(titles[a]))+" \n")&&(result+=$.trim(unescape(titles[a]))+" \n");else for(var af=0;af<resultArray.length;af++)-1==result.indexOf(unescape(resultArray[af])+" \n")&&(result+=unescape(resultArray[af])+" \n")}var dataEndpoint=containerBox.attr("data-endpoint")||"";(0==values.length&&0==uris.length||0==dataEndpoint.indexOf("http://system/dummy"))&&(-1!=containerBox.attr("data-endpoint").indexOf("http://system/dummy")&&containerBox.attr("data-endpoint",LodLiveUtils.lang("endpointNotConfigured")),0==uris.length&&0==values.length&&(result='<div class="boxTitle" data-tooltip="'+LodLiveUtils.lang("resourceMissing")+'"><a target="_blank" href="'+thisUri+'"><span class="spriteLegenda"></span>'+thisUri+"</a>")),result+="</span></div>";var jResult=$(result);""==jResult.text()&&"bnode"==docType?jResult.text("[blank node]"):""==jResult.text()&&jResult.text(LodLiveUtils.lang("noName")),destBox.append(jResult);var resourceTitle=jResult.text();jResult.data("tooltip",resourceTitle),jResult.css({marginTop:13==jResult.height()?58:26==jResult.height()?51:45,height:jResult.height()+5}),destBox.hover(function(){var e=jResult.text();console.log("destbox hover title",e),inst.msg(e,"show","fullInfo",containerBox.attr("data-endpoint"))},function(){inst.msg(null,"hide")});var connectedDocs=[],invertedDocs=[],propertyGroup={},propertyGroupInverted={},connectedImages=[],connectedLongs=[],connectedLats=[],sameDocControl=[];if($.each(uris,function(key,value){for(var akey in value)if(lodLiveProfile.uriSubstitutor&&$.each(lodLiveProfile.uriSubstitutor,function(e,t){value[akey]=value[akey].replace(t.findStr,t.replaceStr)}),$.inArray(akey,images)>-1)eval("connectedImages.push({'"+value[akey]+"':'"+escape(resourceTitle)+"'})");else if(-1==$.inArray(akey,weblinks))if($.inArray(value[akey],sameDocControl)>-1){var aCounter=0;$.each(connectedDocs,function(key2,value2){for(var akey2 in value2)value2[akey2]==value[akey]&&eval("connectedDocs["+aCounter+"] = {'"+akey2+" | "+akey+"':'"+value[akey]+"'}");aCounter++})}else eval("connectedDocs.push({'"+akey+"':'"+value[akey]+"'})"),sameDocControl.push(value[akey])}),inverses&&(sameDocControl=[],$.each(inverses,function(key,value){for(var akey in value)if("bnode"!=docType||-1==value[akey].indexOf("~~"))if(lodLiveProfile.uriSubstitutor&&$.each(lodLiveProfile.uriSubstitutor,function(e,t){value[akey]=value[akey].replace(escape(t.findStr),escape(t.replaceStr))}),$.inArray(value[akey],sameDocControl)>-1){var aCounter=0;$.each(invertedDocs,function(key2,value2){for(var akey2 in value2)if(value2[akey2]==value[akey]){var theKey=akey2;return akey2!=akey&&(theKey=akey2+" | "+akey),eval("invertedDocs["+aCounter+"] = {'"+theKey+"':'"+value[akey]+"'}"),!1}aCounter++})}else eval("invertedDocs.push({'"+akey+"':'"+value[akey]+"'})"),sameDocControl.push(value[akey])})),inst.doDrawMap){for(var a=0;a<points.length;a++)for(var resultArray=inst.getJsonValue(values,points[a],points[a]),af=0;af<resultArray.length;af++)-1!=resultArray[af].indexOf(" ")?(eval("connectedLongs.push('"+unescape(resultArray[af].split(" ")[1])+"')"),eval("connectedLats.push('"+unescape(resultArray[af].split(" ")[0])+"')")):-1!=resultArray[af].indexOf("-")&&(eval("connectedLongs.push('"+unescape(resultArray[af].split("-")[1])+"')"),eval("connectedLats.push('"+unescape(resultArray[af].split("-")[0])+"')"));for(var a=0;a<longs.length;a++)for(var resultArray=inst.getJsonValue(values,longs[a],longs[a]),af=0;af<resultArray.length;af++)eval("connectedLongs.push('"+unescape(resultArray[af])+"')");for(var a=0;a<lats.length;a++)for(var resultArray=inst.getJsonValue(values,lats[a],lats[a]),af=0;af<resultArray.length;af++)eval("connectedLats.push('"+unescape(resultArray[af])+"')");if(connectedLongs.length>0&&connectedLats.length>0){var mapsMap=inst.mapsMap;mapsMap[containerBox.attr("id")]={longs:connectedLongs[0],lats:connectedLats[0],title:thisUri+"\n"+escape(resourceTitle)},inst.updateMapPanel(inst.context.find(".lodlive-controlPanel"))}}if(inst.doCollectImages&&connectedImages.length>0){var imagesMap=inst.imagesMap;imagesMap[containerBox.attr("id")]=connectedImages,inst.updateImagePanel(inst.context.find(".lodlive-controlPanel"))}var totRelated=connectedDocs.length+invertedDocs.length;if(totRelated>16){$.each(connectedDocs,function(e,t){for(var n in t)if(propertyGroup[n]){var i=propertyGroup[n];i.push(t[n]),propertyGroup[n]=i}else propertyGroup[n]=[t[n]]}),$.each(invertedDocs,function(e,t){for(var n in t)if(propertyGroupInverted[n]){var i=propertyGroupInverted[n];i.push(t[n]),propertyGroupInverted[n]=i}else propertyGroupInverted[n]=[t[n]]}),totRelated=0;for(var prop in propertyGroup)propertyGroup.hasOwnProperty(prop)&&totRelated++;for(var prop in propertyGroupInverted)propertyGroupInverted.hasOwnProperty(prop)&&totRelated++}var chordsList=inst.circleChords(75,24,destBox.position().left+65,destBox.position().top+65),chordsListGrouped=inst.circleChords(95,36,destBox.position().left+65,destBox.position().top+65),a=1,inserted={},counter=0,innerCounter=1,objectList=[],innerObjectList=[];$.each(connectedDocs,function(e,t){16==counter&&(counter=0),1==a||15==a&&(a=1);for(var n in t){var i=null;if(propertyGroup[n]&&propertyGroup[n].length>1){if(!inserted[n]){innerCounter=1,inserted[n]=!0;var o=$('<div class="groupedRelatedBox sprite" rel="'+MD5(n)+'"    data-title="'+n+" \n "+propertyGroup[n].length+" "+LodLiveUtils.lang("connectedResources")+'" ></div>'),s=n.split(" ");if(-1!=unescape(propertyGroup[n][0]).indexOf("~~"))o.addClass("isBnode");else for(var r=0;r<s.length;r++)lodLiveProfile.arrows[s[r]]&&o.addClass(lodLiveProfile.arrows[s[r]]);o.attr("style","top:"+(chordsList[a][1]-8)+"px;left:"+(chordsList[a][0]-8)+"px"),objectList.push(o),a++,counter++}25>innerCounter&&(i=$('<div class="aGrouped relatedBox sprite '+MD5(n)+" "+MD5(unescape(t[n]))+'" rel="'+unescape(t[n])+'"  data-title="'+n+" \n "+unescape(t[n])+'" ></div>'),i.attr("style","display:none;position:absolute;top:"+(chordsListGrouped[innerCounter][1]-8)+"px;left:"+(chordsListGrouped[innerCounter][0]-8)+"px"),i.attr("data-circlePos",innerCounter),i.attr("data-circleParts",36),i.attr("data-circleid",containerBox.attr("id"))),innerCounter++}else i=$('<div class="relatedBox sprite '+MD5(unescape(t[n]))+'" rel="'+unescape(t[n])+'"   data-title="'+n+" \n "+unescape(t[n])+'" ></div>'),i.attr("style","top:"+(chordsList[a][1]-8)+"px;left:"+(chordsList[a][0]-8)+"px"),i.attr("data-circlePos",a),i.attr("data-circleParts",24),a++,counter++;if(i){i.attr("data-circleid",containerBox.attr("id")),i.attr("data-property",n);var s=n.split(" ");if(-1!=i.attr("rel").indexOf("~~"))i.addClass("isBnode");else for(var r=0;r<s.length;r++)lodLiveProfile.arrows[s[r]]&&i.addClass(lodLiveProfile.arrows[s[r]]);i.hasClass("aGrouped")?innerObjectList.push(i):objectList.push(i)}}}),inserted={},$.each(invertedDocs,function(e,t){16==counter&&(counter=0),1==a||15==a&&(a=1);for(var n in t){var i=null;if(propertyGroupInverted[n]&&propertyGroupInverted[n].length>1){if(!inserted[n]){innerCounter=1,inserted[n]=!0;var o=$('<div class="groupedRelatedBox sprite inverse" rel="'+MD5(n)+'-i"   data-title="'+n+" \n "+propertyGroupInverted[n].length+" "+LodLiveUtils.lang("connectedResources")+'" ></div>'),s=n.split(" ");if(-1!=unescape(propertyGroupInverted[n][0]).indexOf("~~"))o.addClass("isBnode");else for(var r=0;r<s.length;r++)lodLiveProfile.arrows[s[r]]&&o.addClass(lodLiveProfile.arrows[s[r]]);o.attr("style","top:"+(chordsList[a][1]-8)+"px;left:"+(chordsList[a][0]-8)+"px"),objectList.push(o),a++,counter++}if(25>innerCounter){var l=unescape(0==t[n].indexOf("~~")?thisUri+t[n]:t[n]);i=$('<div class="aGrouped relatedBox sprite inverse '+MD5(n)+"-i "+MD5(unescape(t[n]))+' " rel="'+l+'"  data-title="'+n+" \n "+unescape(t[n])+'" ></div>'),i.attr("style","display:none;position:absolute;top:"+(chordsListGrouped[innerCounter][1]-8)+"px;left:"+(chordsListGrouped[innerCounter][0]-8)+"px"),i.attr("data-circlePos",innerCounter),i.attr("data-circleParts",36),i.attr("data-circleId",containerBox.attr("id"))}innerCounter++}else i=$('<div class="relatedBox sprite inverse '+MD5(unescape(t[n]))+'" rel="'+unescape(t[n])+'"   data-title="'+n+" \n "+unescape(t[n])+'" ></div>'),i.attr("style","top:"+(chordsList[a][1]-8)+"px;left:"+(chordsList[a][0]-8)+"px"),i.attr("data-circlePos",a),i.attr("data-circleParts",24),a++,counter++;if(i){i.attr("data-circleId",containerBox.attr("id")),i.attr("data-property",n);var s=n.split(" ");if(-1!=i.attr("rel").indexOf("~~"))i.addClass("isBnode");else for(var r=0;r<s.length;r++)lodLiveProfile.arrows[s[r]]&&i.addClass(lodLiveProfile.arrows[s[r]]);i.hasClass("aGrouped")?innerObjectList.push(i):objectList.push(i)}}});for(var page=0,totPages=objectList.length>14?objectList.length/14+(objectList.length%14>0?1:0):1,i=0;i<objectList.length;i++){if(i%14==0){page++;var aPage=$('<div class="page page'+page+'" style="display:none"></div>');page>1&&totPages>1&&aPage.append('<div class="pager pagePrev sprite" data-page="page'+(page-1)+'" style="top:'+(chordsList[0][1]-8)+"px;left:"+(chordsList[0][0]-8)+'px"></div>'),totPages>1&&totPages-1>page&&aPage.append('<div class="pager pageNext sprite" data-page="page'+(page+1)+'" style="top:'+(chordsList[15][1]-8)+"px;left:"+(chordsList[15][0]-8)+'px"></div>'),containerBox.append(aPage)}containerBox.children(".page"+page).append(objectList[i])}if(page=0,totPages=innerObjectList.length/24+(innerObjectList.length%24>0?1:0),innerObjectList.length>0){containerBox.append('<div class="innerPage"></div>');for(var i=0;i<innerObjectList.length;i++)containerBox.children(".innerPage").append(innerObjectList[i])}containerBox.children(".page1").fadeIn("fast"),containerBox.children(".page").children(".pager").click(function(){var e=$(this);containerBox.find(".lastClick").removeClass("lastClick").click(),e.parent().fadeOut("fast",null,function(){$(this).parent().children("."+e.attr("data-page")).fadeIn("fast")})});var obj=$('<div class="actionBox contents" rel="contents"  >&#160;</div>');containerBox.append(obj),obj.hover(function(){$(this).parent().children(".box").setBackgroundPosition({y:-260})},function(){$(this).parent().children(".box").setBackgroundPosition({y:0})}),obj=$('<div class="actionBox tools" rel="tools" >&#160;</div>'),containerBox.append(obj),obj.hover(function(){containerBox.children(".box").setBackgroundPosition({y:-130})},function(){containerBox.children(".box").setBackgroundPosition({y:0})}),inst.debugOn&&console.debug((new Date).getTime()-start+"	format ")},LodLive.prototype.openDoc=function(anUri,destBox,fromInverse){var inst=this;anUri||$.error("LodLive: no uri for openDoc"),inst.debugOn&&(start=(new Date).getTime());var uris=[],values=[];inst.showInfoConsole&&(inst.queryConsole("init",{uriId:anUri}),inst.queryConsole("log",{uriId:anUri,resource:anUri})),inst.debugOn&&console.log("composing query with anUri",anUri);var SPARQLquery=inst.composeQuery(anUri,"documentUri");if(inst.doStats&&methods.doStats(anUri),-1!=SPARQLquery.indexOf("endpoint=")){var endpoint=SPARQLquery.substring(SPARQLquery.indexOf("endpoint=")+9);endpoint=endpoint.substring(0,endpoint.indexOf("&")),destBox.attr("data-endpoint",endpoint)}else destBox.attr("data-endpoint",SPARQLquery.substring(0,SPARQLquery.indexOf("?")));0==SPARQLquery.indexOf("http://system/dummy")?inst.guessingEndpoint(anUri,function(){inst.openDoc(anUri,destBox,fromInverse)},function(){inst.parseRawResource(destBox,anUri,fromInverse)}):$.ajax({url:SPARQLquery,beforeSend:function(){destBox.children(".box").html('<img style="margin-top:'+(destBox.children(".box").height()/2-8)+'px" src="img/ajax-loader.gif"/>')},success:function(json){json=json.results&&json.results.bindings;var conta=0;if($.each(json,function(e,t){var n={},i={};conta++,"uri"===t.object.type||"bnode"===t.object.type?t.object.value==anUri||"bnode"===t.object.type&&inst.ignoreBnodes||(i[t.property.value]=escape("bnode"===t.object.type?anUri+"~~"+t.object.value:t.object.value),uris.push(i)):(n[t.property.value]=escape(t.object.value),values.push(n))}),inst.showInfoConsole&&inst.queryConsole("log",{founded:conta,id:SPARQLquery,uriId:anUri}),inst.debugOn&&console.debug((new Date).getTime()-start+"	openDoc eval uris & values"),destBox.children(".box").html(""),inst.doInverse){SPARQLquery=inst.composeQuery(anUri,"inverse");var inverses=[];$.ajax({url:SPARQLquery,beforeSend:function(){destBox.children(".box").html('<img style="margin-top:'+(destBox.children(".box").height()/2-5)+'px" src="img/ajax-loader.gif"/>')},success:function(json){json=json.results.bindings;var conta=0;$.each(json,function(key,value){conta++,eval("inverses.push({'"+value.property.value+"':'"+("bnode"==value.object.type?anUri+"~~":"")+escape(value.object.value)+"'})")}),inst.showInfoConsole&&inst.queryConsole("log",{founded:conta,id:SPARQLquery,uriId:anUri}),inst.debugOn&&console.debug((new Date).getTime()-start+"	openDoc inverse eval uris ");var callback=function(){destBox.children(".box").html(""),inst.format(destBox.children(".box"),values,uris,inverses),inst.addClick(destBox,fromInverse?function(){try{$(fromInverse).click()}catch(e){}}:null),inst.doAutoExpand&&inst.autoExpand(destBox)};if(inst.doAutoSameas){var counter=0,tot=Object.keys(lodLiveProfile).length;inst.findInverseSameAs(anUri,counter,inverses,callback,tot)}else callback()},error:function(){destBox.children(".box").html(""),inst.format(destBox.children(".box"),values,uris),inst.showInfoConsole&&inst.queryConsole("log",{error:"error",id:SPARQLquery,uriId:anUri}),inst.addClick(destBox,fromInverse?function(){try{$(fromInverse).click()}catch(e){}}:null),inst.doAutoExpand&&inst.autoExpand(destBox)
}})}else inst.format(destBox.children(".box"),values,uris),inst.addClick(destBox,fromInverse?function(){try{$(fromInverse).click()}catch(e){}}:null),inst.doAutoExpand&&inst.autoExpand(destBox)},error:function(){inst.errorBox(destBox)}}),inst.debugOn&&console.debug((new Date).getTime()-start+"	openDoc")},LodLive.prototype.parseRawResource=function(destBox,resource,fromInverse){var inst=this,values=[],uris=[],lodLiveProfile=inst.profile;if(lodLiveProfile["default"]){var res=LodLiveUtils.getSparqlConf("documentUri",lodLiveProfile["default"],lodLiveProfile).replace(/\{URI\}/gi,resource),url=lodLiveProfile["default"].endpoint+"?uri="+encodeURIComponent(resource)+"&query="+encodeURIComponent(res);inst.showInfoConsole&&inst.queryConsole("log",{title:LodLiveUtils.lang("endpointNotConfiguredSoInternal"),text:res,uriId:resource}),$.ajax({url:url,beforeSend:function(){destBox.children(".box").html('<img style="margin-top:'+(destBox.children(".box").height()/2-8)+'px" src="img/ajax-loader.gif"/>')},success:function(json){json=json.results.bindings;var conta=0;$.each(json,function(key,value){conta++,"uri"==value.object.type?value.object.value!=resource&&eval("uris.push({'"+value.property.value+"':'"+escape(value.object.value)+"'})"):eval("values.push({'"+value.property.value+"':'"+escape(value.object.value)+"'})")}),inst.debugOn&&console.debug((new Date).getTime()-start+"  openDoc eval uris & values");var inverses=[],callback=function(){destBox.children(".box").html(""),inst.format(destBox.children(".box"),values,uris,inverses),inst.addClick(destBox,fromInverse?function(){try{$(fromInverse).click()}catch(e){}}:null),inst.doAutoExpand&&inst.autoExpand(destBox)};if(inst.doAutoSameas){var counter=0,tot=Object.keys(lodLiveProfile.connection).length;inst.findInverseSameAs(resource,counter,inverses,callback,tot)}else callback()},error:function(e,j,k){destBox.children(".box").html("");var inverses=[];fromInverse&&eval("uris.push({'"+fromInverse.replace(/div\[data-property="([^"]*)"\].*/,"$1")+"':'"+fromInverse.replace(/.*\[rel="([^"]*)"\].*/,"$1")+"'})"),inst.format(destBox.children(".box"),values,uris,inverses),inst.addClick(destBox,fromInverse?function(){try{$(fromInverse).click()}catch(e){}}:null),inst.doAutoExpand&&inst.autoExpand(destBox)}})}else{destBox.children(".box").html("");var inverses=[];fromInverse&&eval("uris.push({'"+fromInverse.replace(/div\[data-property="([^"]*)"\].*/,"$1")+"':'"+fromInverse.replace(/.*\[rel="([^"]*)"\].*/,"$1")+"'})"),inst.format(destBox.children(".box"),values,uris,inverses),inst.addClick(destBox,fromInverse?function(){try{$(fromInverse).click()}catch(e){}}:null),inst.doAutoExpand&&inst.autoExpand(destBox)}},LodLive.prototype.errorBox=function(e){var t=this;e.children(".box").addClass("errorBox"),e.children(".box").html("");var n=$('<div class="boxTitle"><span>'+LodLiveUtils.lang("enpointNotAvailable")+"</span></div>");e.children(".box").append(n),n.css({marginTop:13==n.height()?58:26==n.height()?51:45});var i=$('<div class="actionBox tools">&#160;</div>');i.click(function(){t.removeDoc(e)}),e.append(i),e.children(".box").hover(function(){t.msg(LodLiveUtils.lang("enpointNotAvailableOrSLow"),"show","fullInfo",e.attr("data-endpoint"))},function(){t.msg(null,"hide")})},LodLive.prototype.allClasses=function(e,t,n,i){var o=this;o.debugOn&&(start=(new Date).getTime()),e=o.composeQuery(e,"allClasses");var a=[];$.ajax({url:e,beforeSend:function(){t.html('<img src="img/ajax-loader.gif"/>')},success:function(e){t.html(LodLiveUtils.lang("choose")),e=e.results&&e.results.bindings,$.each(e,function(t){var n=e[t].object.value;-1==n.indexOf("http://www.openlinksw.com/")&&(n=n.replace(/http:\/\//,""),a.push(n))});for(var o=0;o<a.length;o++)n.append(i.replace(/\{CONTENT\}/g,a[o]))},error:function(){n.append(i.replace(/\{CONTENT\}/g,"si Ã¨ verificato un errore"))}}),o.debugOn&&console.debug((new Date).getTime()-start+"  allClasses")},LodLive.prototype.findInverseSameAs=function(anUri,counter,inverse,callback,tot){var inst=this,lodLiveProfile=inst.profile;inst.debugOn&&(start=(new Date).getTime());var innerCounter=0;$.each(lodLiveProfile.connection,function(key,value){if(innerCounter===counter){var skip=!1,keySplit=key.split(",");if(value.useForInverseSameAs)for(var a=0;a<keySplit.length;a++)-1!=anUri.indexOf(keySplit[a])&&(skip=!0);else skip=!0;if(skip)return counter++,tot>counter?inst.findInverseSameAs(anUri,counter,inverse,callback,tot):callback(),!1;var SPARQLquery=value.endpoint+"?"+(value.endpointType?lodLiveProfile.endpoints[value.endpointType]:lodLiveProfile.endpoints.all)+"&query="+escape(LodLiveUtils.getSparqlConf("inverseSameAs",value,lodLiveProfile).replace(/\{URI\}/g,anUri));value.proxy&&(SPARQLquery=value.proxy+"?endpoint="+value.endpoint+"&"+(value.endpointType?lodLiveProfile.endpoints[value.endpointType]:lodLiveProfile.endpoints.all)+"&query="+escape(LodLiveUtils.getSparqlConf("inverseSameAs",value,lodLiveProfile).replace(/\{URI\}/g,anUri))),$.ajax({url:SPARQLquery,timeout:3e3,beforeSend:function(){inst.showInfoConsole&&inst.queryConsole("log",{title:value.endpoint,text:LodLiveUtils.getSparqlConf("inverseSameAs",value,lodLiveProfile).replace(/\{URI\}/g,anUri),id:SPARQLquery,uriId:anUri})},success:function(json){json=json.results.bindings;var conta=0;$.each(json,function(key,value){conta++,eval(value.property&&value.property.value?"inverse.splice(1,0,{'"+value.property.value+"':'"+escape(value.object.value)+"'})":"inverse.splice(1,0,{'http://www.w3.org/2002/07/owl#sameAs':'"+escape(value.object.value)+"'})")}),inst.showInfoConsole&&inst.queryConsole("log",{founded:conta,id:SPARQLquery,uriId:anUri}),counter++,tot>counter?inst.findInverseSameAs(anUri,counter,inverse,callback,tot):callback()},error:function(){inst.showInfoConsole&&inst.queryConsole("log",{error:"error",id:SPARQLquery,uriId:anUri}),counter++,tot>counter?inst.findInverseSameAs(anUri,counter,inverse,callback,tot):callback()}}),inst.debugOn&&console.debug((new Date).getTime()-start+"  findInverseSameAs "+value.endpoint)}innerCounter++}),inst.debugOn&&console.debug((new Date).getTime()-start+"  findInverseSameAs")},LodLive.prototype.findSubject=function(e,t,n,i,o){var a=this,s=a.profile;a.debugOn&&(start=(new Date).getTime()),$.each(s.connection,function(i,o){for(var a=i.split(","),r=0;r<a.length;r++)-1!=e.indexOf(a[r])&&(e=o.endpoint+"?"+(o.endpointType?s.endpoints[o.endpointType]:s.endpoints.all)+"&query="+escape(LodLiveUtils.getSparqlConf("findSubject",o,s).replace(/\{CLASS\}/g,t).replace(/\{VALUE\}/g,n)),o.proxy&&(e=o.proxy+"?endpoint="+o.endpoint+"&"+(o.endpointType?s.endpoints[o.endpointType]:s.endpoints.all)+"&query="+escape(LodLiveUtils.getSparqlConf("findSubject",o,s).replace(/\{CLASS\}/g,t).replace(/\{VALUE\}/g,n))))});var r=[];$.ajax({url:e,beforeSend:function(){i.html('<img src="img/ajax-loader.gif"/>')},success:function(e){i.html(""),e=e.results&&e.results.bindings,$.each(e,function(t){r.push(e[t].subject.value)});for(var t=0;t<r.length;t++)o.val(r[t])},error:function(e){i.html("errore: "+e)}}),a.debugOn&&console.debug((new Date).getTime()-start+"  findSubject")},LodLive.prototype.standardLine=function(e,t,n,i,o,a){var s=180*Math.atan2(o-n,i-t)/Math.PI+180,r=t-Math.sqrt((i-t)*(i-t)+(o-n)*(o-n))+60;a.rotateCanvas({rotate:s,x:t,y:n}).drawLine({strokeStyle:"#fff",strokeWidth:1,strokeCap:"bevel",x1:t-60,y1:n,x2:r,y2:n}),s>90&&270>s&&a.rotateCanvas({rotate:180,x:(r+t)/2,y:(n+n)/2}),e=$.trim(e).replace(/\n/g,", "),a.drawText({fillStyle:"#606060",strokeStyle:"#606060",x:(r+t+(t+60>i?-60:60))/2,y:(n+n-(t+60>i?18:-18))/2,text:e,align:"center",strokeWidth:.01,fontSize:11,fontFamily:"'Open Sans',Verdana"}).restoreCanvas().restoreCanvas(),s=Math.atan2(o-n,i-t);var l=.79,d=Math.abs(8/Math.cos(l)),c=i-60*Math.cos(s),p=o-60*Math.sin(s),u=s+Math.PI+l,v=i+Math.cos(u)*d-60*Math.cos(s),f=o+Math.sin(u)*d-60*Math.sin(s),h=s+Math.PI-l,g=i+Math.cos(h)*d-60*Math.cos(s),m=o+Math.sin(h)*d-60*Math.sin(s);a.drawLine({strokeStyle:"#fff",strokeWidth:1,x1:c,y1:p,x2:g,y2:m}),a.drawLine({strokeStyle:"#fff",strokeWidth:1,x1:c,y1:p,x2:v,y2:f})},window.LodLive||(window.LodLive=LodLive),jQuery.fn.lodlive=function(e){return arguments.length?("string"==typeof e&&(e={method:e}),this.each(function(){var t=$(this),n=t.data("lodlive-instance");e.method&&"init"!==e.method.toLowerCase()?LodLive.prototype.hasOwnProperty(method)&&t.data("lodlive-instance")?n[method].apply(n,method.args||[]):jQuery.error("Method "+method+" does not exist on jQuery.lodlive"):(n=new LodLive(e.profile),t.data("lodlive-instance",n),n.init(t,e))})):this.data("lodlive-instance")}}(jQuery);